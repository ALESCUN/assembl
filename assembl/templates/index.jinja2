{% extends 'base.jinja2' %}

{% block extra_header %}{% endblock %}

{% block content %}
    <div id="inbox"></div>

    <div id="message">

        <div class="bar bar--title">
            <div class="bar-body">
                <div class="bar-left">
                    <a href="#" class="arrowbutton">Previous</a>
                </div>

                <div class="bar-center">Message</div>

                <div class="bar-right">
                    <a href="#" class="arrowbutton arrowbutton--right">Next</a>
                </div>
            </div>
        </div>

        <div class="message container">
            <div class="message-header">
                
                <div class="media">
                    <div class="media-imgleft">
                        <img src="http://www.gravatar.com/avatar/39cbf87dae724f2cb64e92accdd4d349.jpg?s=38" alt="User"  class="image-rounded" />
                    </div>
                    <div class="media-body">
                        <div class="margin-bottom">
                            <strong>Bénigne Morin</strong> a dit <time>9, juin 2013</time>
                        </div>
                        <span>Synthèse intermédiaire : Monnaies de récompense</span>
                    </div>
                </div>

            </div>

            <div class="message-body">
                
                <div class="text">{{ lipsum(n=5, html=True) }}</div>

            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
requirejs(["app", "views/inbox", "models/email"],
function(app, Inbox, Email){
    'use strict';

    app.init();

    //app.inbox = new Inbox({collection: app.emails});
    //app.inbox.render();

    //app.message = new Message();

    //

    function doTheSelection(ev){
        window.setTimeout(function(){
            var sel = document.getSelection();

            if( sel.type === "None" ){
                if( app.bubble ) {
                    app.bubble.remove();
                    app.bubble = null;
                }
                return;
            }

            var selectedText = sel.getRangeAt(0).cloneContents();
            if(selectedText.firstChild && selectedText.firstChild.textContent.length > 10 ){
                showBubble(app.mouse.x, app.mouse.y, selectedText.firstChild.textContent);
            }
        })
    }

    function showBubble(x, y, text){
        if( ! app.bubble ) {

            var div = $('<div>', { 'class': 'textbubble' } );
            
            $('#wrapper').append(div);
            
            div.click(function(ev){
                alert( div.attr('data-segment') );
            });

            app.bubble = div;
        }

        text = '...' + text.substr(-15);

        app.bubble
            .attr('data-segment', text)
            .text(text)
                .css({
                    'top': y,
                    'left': x,
                    'margin-left': app.bubble.width() / -2
                });
    }

    //$('.text').on('mouseup', doTheSelection);

    $(document).on('selectionchange', doTheSelection);
    $(document).on('mousemove', function(ev){
        app.mouse = { x: ev.x, y: ev.y };
    });
});
</script>
{% endblock %}
