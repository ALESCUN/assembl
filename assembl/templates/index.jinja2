{% extends 'base.jinja2' %}

{% block extra_header %}{% endblock %}

{% block content %}
    <div id="inbox"></div>

    <div id="message">

        <div class="bar bar--title">
            <div class="bar-body">
                <div class="bar-left">
                    <a href="#" class="arrowbutton">Previous</a>
                </div>

                <div class="bar-center">Message</div>

                <div class="bar-right">
                    <a href="#" class="arrowbutton arrowbutton--right">Next</a>
                </div>
            </div>
        </div>

        <div class="message">
            <div class="message-header">
                
                <div class="media">
                    <div class="media-imgleft">
                        <img src="http://www.gravatar.com/avatar/39cbf87dae724f2cb64e92accdd4d349.jpg?s=38" alt="User"  class="image-rounded" />
                    </div>
                    <div class="media-body">
                        <div class="margin-bottom">
                            <strong>Bénigne Morin</strong> a dit <time>9, juin 2013</time>
                        </div>
                        <span>Synthèse intermédiaire : Monnaies de récompense</span>
                    </div>
                </div>

            </div>

            <div class="message-body">
                
                <div class="text">{{ lipsum(n=5, html=True) }}</div>

            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
requirejs(["app", "views/inbox", "models/email"],
function(app, Inbox, Email){
    'use strict';

    app.init();

    //app.inbox = new Inbox({collection: app.emails});
    //app.inbox.render();

    //app.message = new Message();

    //

    var SELECTION_CLASS = 'text-selection';

    function cleanSelection(){
        $('.text-selection').removeClass(SELECTION_CLASS);
    }

    function doTheSelection(ev){
        /*
        cleanSelection();
        var sel = window.getSelection(),
            range = sel.getRangeAt(0),
            content = range.cloneContents();

        if( content.firstChild === null ){
            return;
        }

        var textBlock = $(ev.target).closest('.text');

        textBlock.find('p').each(function(i, el){
            if( sel.containsNode( el ) ) {
                el.classList.add(SELECTION_CLASS);
            }
        });


        if( sel.baseNode === sel.extentNode ) {
            // just one paragraph
            var span = document.createElement('span');
            span.className = SELECTION_CLASS;
            range.surroundContents(span);
        } else {

            // The first
            var r1 = document.createRange();
            r1.setStart(sel.baseNode, sel.baseOffset);
            r1.setEnd(sel.baseNode, sel.baseNode.wholeText.length);

            var span = document.createElement('span');
            span.className = SELECTION_CLASS;
            r1.surroundContents( span );

            var r2 = document.createRange();
            r2.setStart(sel.extentNode, 0);
            r2.setEnd(sel.extentNode, sel.extentOffset);

            var span = document.createElement('span');
            span.className = SELECTION_CLASS;
            r2.surroundContents( span );          
        }
    */
        showBubble(ev.x, ev.y);
    }

    function showBubble(x, y){
        $('.bubble').remove();

        var div = $('<div>', { 'class': 'bubble' } );
        div.text('Segment this?');
        div.css('top', y - 30);
        div.css('left', x - 15);
        //div.css('margin-left', span.offsetWidth/2);
        $(document.body).append(div);
        div.css('margin-left', div.width()/-2);
    }

    $('.text').on('mouseup', doTheSelection);

    //$(document).on('selectionchange', doTheSelection);
});
</script>
{% endblock %}
